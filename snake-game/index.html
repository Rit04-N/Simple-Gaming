<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retro Snake</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêç</text></svg>">
    
    <style>
        /* --- 1. THEME: RETRO GREEN & DARK --- */
        :root {
            --bg-dark: #050d08;      /* Very dark green/black */
            --bg-panel: #0a1a0f;     /* Slightly lighter panel */
            --snake-green: #2ecc71;  /* The Bright Green */
            --snake-dark: #27ae60;   /* Darker Green for body */
            --apple-red: #e74c3c;    /* Classic Apple Red */
            --text-main: #e0ffe0;    /* Pale Green Text */
        }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: none; /* Stops scrolling */
            overflow-x: hidden;
            padding-bottom: 20px;
        }

        h1 {
            color: var(--snake-green);
            text-shadow: 0 0 15px rgba(46, 204, 113, 0.4);
            margin: 15px 0 5px 0;
            font-size: 2.2rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* --- 2. GAME BOARD --- */
        .game-wrapper {
            position: relative;
            padding: 10px;
            background: var(--bg-panel);
            border: 2px solid var(--snake-green);
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.15);
            width: 90vw; 
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .score-board {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--snake-green);
        }

        canvas {
            background: #000;
            border: 2px solid #14331e;
            border-radius: 8px;
            display: block;
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 1;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }

        /* --- 3. UI ELEMENTS --- */
        .btn {
            background: var(--snake-green);
            color: #05180b;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 15px;
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
            text-transform: uppercase;
        }
        .btn:active { transform: scale(0.95); }

        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 13, 8, 0.95);
            border-radius: 13px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        .overlay.hidden { display: none; }
        .overlay h2 { font-size: 2.5rem; margin: 0 0 10px 0; color: var(--snake-green); }

        /* --- 4. ACCURATE JOYSTICK --- */
        .joystick-container {
            margin-top: 25px;
            width: 140px;
            height: 140px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(46, 204, 113, 0.3);
            border-radius: 50%;
            position: relative;
            touch-action: none; 
            display: none; /* Hidden on PC */
        }

        @media (hover: none) and (pointer: coarse) {
            .joystick-container { display: block; }
        }

        .joystick-knob {
            width: 50px;
            height: 50px;
            background: var(--snake-green);
            border-radius: 50%;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px var(--snake-green);
            pointer-events: none;
            transition: transform 0.05s linear; 
        }

        /* --- 5. INSTRUCTIONS --- */
        .instructions {
            margin-top: 25px;
            font-size: 0.9rem;
            color: #8dafa0;
            text-align: center;
            line-height: 1.6;
        }
        .instructions strong { color: var(--snake-green); }

        .back-link {
            margin-top: 20px;
            color: var(--snake-green);
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.7;
        }
    </style>
</head>
<body>

    <h1>Retro Snake</h1>

    <div class="game-wrapper">
        <div class="score-board">
            <span id="scoreText">Apples: 0</span>
            <span id="highScoreText" style="color: #ffd700; opacity: 0.8;">Best: 0</span>
        </div>

        <canvas id="gameCanvas" width="400" height="400"></canvas>

        <div id="gameOverlay" class="overlay">
            <h2 id="overlayTitle">READY?</h2>
            <p id="finalScore" style="display:none; color:white; font-size: 1.2rem;">Score: 0</p>
            <button class="btn" onclick="startGame()">‚ñ∂ START GAME</button>
        </div>
    </div>

    <div class="joystick-container" id="joystick">
        <div class="joystick-knob" id="knob"></div>
    </div>

    <div class="instructions">
        <strong>Controls:</strong><br>
        üíª PC: Arrow Keys<br>
        üì± Mobile: Use the Joystick below
    </div>

    <a href="../index.html" class="back-link">‚Üê Back to Gaming Hub</a>

    <script>
        // --- 1. CONFIGURATION ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const GRID_SIZE = 20; 
        const TILE_COUNT = 20; 
        const GAME_SPEED = 110; 
        
        let snake = [];
        let apple = {};
        let velocity = { x: 0, y: 0 };
        let nextVelocity = { x: 0, y: 0 };
        let score = 0;
        let highScore = localStorage.getItem('snakeHighScore') || 0;
        let gameInterval;
        let isGameRunning = false;

        document.getElementById('highScoreText').innerText = "Best: " + highScore;

        // --- 2. AUDIO SYSTEM ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function playSound(type) {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'eat') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'crash') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            }
        }

        // --- 3. GAME LOOP ---
        function startGame() {
            if (!audioCtx) audioCtx = new AudioContext();
            isGameRunning = true;
            document.getElementById('gameOverlay').classList.add('hidden');
            
            snake = [{x: 10, y: 10}, {x: 9, y: 10}, {x: 8, y: 10}];
            velocity = { x: 1, y: 0 }; 
            nextVelocity = { x: 1, y: 0 };
            
            score = 0;
            document.getElementById('scoreText').innerText = "Apples: 0";
            
            spawnApple();
            
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(update, GAME_SPEED);
        }

        function update() {
            velocity = { ...nextVelocity };
            const head = { x: snake[0].x + velocity.x, y: snake[0].y + velocity.y };

            // Wall Collision
            if (head.x < 0 || head.x >= TILE_COUNT || head.y < 0 || head.y >= TILE_COUNT) {
                gameOver(); return;
            }

            // Self Collision
            for (let part of snake) {
                if (head.x === part.x && head.y === part.y) {
                    gameOver(); return;
                }
            }

            snake.unshift(head); 

            // Apple Collision
            if (head.x === apple.x && head.y === apple.y) {
                score++;
                document.getElementById('scoreText').innerText = "Apples: " + score;
                playSound('eat');
                spawnApple();
            } else {
                snake.pop(); 
            }

            draw();
        }

        function draw() {
            // Background
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Apple (Red)
            ctx.fillStyle = "#e74c3c";
            ctx.beginPath();
            ctx.arc(apple.x * GRID_SIZE + 10, apple.y * GRID_SIZE + 10, 8, 0, Math.PI * 2);
            ctx.fill();

            // Snake
            snake.forEach((part, index) => {
                // Head is Bright Green, Body is Darker Green
                ctx.fillStyle = (index === 0) ? "#2ecc71" : "#27ae60";
                
                ctx.beginPath();
                ctx.roundRect(part.x * GRID_SIZE + 1, part.y * GRID_SIZE + 1, GRID_SIZE - 2, GRID_SIZE - 2, 4);
                ctx.fill();

                // Eyes
                if (index === 0) {
                    ctx.fillStyle = "black";
                    const x = part.x * GRID_SIZE;
                    const y = part.y * GRID_SIZE;
                    // Simple logic to place eyes based on general existence
                    ctx.fillRect(x + 5, y + 5, 4, 4); 
                    ctx.fillRect(x + 11, y + 5, 4, 4);
                }
            });
        }

        function spawnApple() {
            apple = {
                x: Math.floor(Math.random() * TILE_COUNT),
                y: Math.floor(Math.random() * TILE_COUNT)
            };
            for (let part of snake) {
                if (part.x === apple.x && part.y === apple.y) spawnApple();
            }
        }

        function gameOver() {
            clearInterval(gameInterval);
            isGameRunning = false;
            playSound('crash');

            if (score > highScore) {
                highScore = score;
                localStorage.setItem('snakeHighScore', highScore);
                document.getElementById('highScoreText').innerText = "Best: " + highScore;
            }

            document.getElementById('overlayTitle').innerText = "GAME OVER";
            document.getElementById('finalScore').innerText = "Score: " + score;
            document.getElementById('finalScore').style.display = "block";
            document.getElementById('gameOverlay').classList.remove('hidden');
        }

        // --- 4. CONTROLS (PC) ---
        document.addEventListener('keydown', (e) => {
            if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Space"].includes(e.code)) {
                e.preventDefault(); 
            }
            if (!isGameRunning) return;

            switch(e.key) {
                case 'ArrowUp': 
                    if (velocity.y === 0) nextVelocity = {x: 0, y: -1}; break;
                case 'ArrowDown': 
                    if (velocity.y === 0) nextVelocity = {x: 0, y: 1}; break;
                case 'ArrowLeft': 
                    if (velocity.x === 0) nextVelocity = {x: -1, y: 0}; break;
                case 'ArrowRight': 
                    if (velocity.x === 0) nextVelocity = {x: 1, y: 0}; break;
            }
        });

        // --- 5. HIGH ACCURACY JOYSTICK (ANGLE BASED) ---
        const joystick = document.getElementById('joystick');
        const knob = document.getElementById('knob');
        let isDragging = false;
        
        joystick.addEventListener('touchstart', (e) => {
            if (!isGameRunning) return;
            isDragging = true;
            updateJoystick(e.touches[0].clientX, e.touches[0].clientY);
        });

        joystick.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            e.preventDefault(); 
            updateJoystick(e.touches[0].clientX, e.touches[0].clientY);
        });

        joystick.addEventListener('touchend', () => {
            isDragging = false;
            knob.style.transform = `translate(-50%, -50%)`; 
        });

        function updateJoystick(touchX, touchY) {
            const rect = joystick.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            let deltaX = touchX - centerX;
            let deltaY = touchY - centerY;
            
            // Visual Limit
            const distance = Math.sqrt(deltaX*deltaX + deltaY*deltaY);
            const maxRadius = 40;
            
            if (distance > maxRadius) {
                const angle = Math.atan2(deltaY, deltaX);
                deltaX = Math.cos(angle) * maxRadius;
                deltaY = Math.sin(angle) * maxRadius;
            }

            knob.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;

            // DIRECTION LOGIC (Using Angle for Accuracy)
            // This prevents "dead zones" in diagonal movement
            const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;

            // Right: -45 to 45
            // Down: 45 to 135
            // Left: 135 to 180 AND -180 to -135
            // Up: -135 to -45

            if (distance > 10) { // Slight deadzone to prevent accidental jitter
                if (angle > -45 && angle <= 45) {
                    if (velocity.x === 0) nextVelocity = {x: 1, y: 0}; // Right
                } else if (angle > 45 && angle <= 135) {
                    if (velocity.y === 0) nextVelocity = {x: 0, y: 1}; // Down
                } else if (angle > -135 && angle <= -45) {
                    if (velocity.y === 0) nextVelocity = {x: 0, y: -1}; // Up
                } else {
                    if (velocity.x === 0) nextVelocity = {x: -1, y: 0}; // Left
                }
            }
        }
    </script>
</body>
</html>
